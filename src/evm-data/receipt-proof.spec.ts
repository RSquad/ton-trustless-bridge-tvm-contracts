import {rlp} from 'ethereumjs-util';

import {BlockHeader} from './block-header';
import {IReceiptJSON, Receipt} from './receipt';
import {bytes, toNumber} from './utils';
import {verifyMerkleProof} from './verify-merkle-proof';


describe('Receipt proof test', () => {

  it('should check proof from JSON', async () => {

    const {receipt, receiptProof, blockHeader} = json;
    const r = Receipt.fromJSON(receipt as unknown as IReceiptJSON);
    const block = BlockHeader.fromHex(blockHeader);

    // verifiy the proof
    const res = await verifyMerkleProof(
      block.receiptTrie, // expected merkle root
      rlp.encode(toNumber(receipt.transactionIndex)), // path, which is the transsactionIndex
      receiptProof.map(bytes), // array of Buffer with the merkle-proof-data
      r.serialize(),
      'The TransactionReceipt can not be verified'
    );

  });
});


const json = {
  "receipt": {
    "transactionHash": "0xbffc12fff51d9508c181668cae32364d407fd56ac900213f9529cb4f51865bfc",
    "transactionIndex": "0x2a",
    "blockHash": "0x8824b96f41f41ffdf2daf5a0dabc2fd7a76834ec4e81056556e63e467955f520",
    "blockNumber": "0x37946c",
    "cumulativeGasUsed": "0x3facc9",
    "gasUsed": "0x13a80",
    "effectiveGasPrice": "0x59682f0d",
    "from": "0x444589873456c218a274d933a8b5a28821292811",
    "to": "0x572af1afa5afcfc6fdf1eb2913aa4463037860e8",
    "contractAddress": null,
    "logs": [
      {
        "removed": false,
        "logIndex": "0x54",
        "transactionIndex": "0x2a",
        "transactionHash": "0xbffc12fff51d9508c181668cae32364d407fd56ac900213f9529cb4f51865bfc",
        "blockHash": "0x8824b96f41f41ffdf2daf5a0dabc2fd7a76834ec4e81056556e63e467955f520",
        "blockNumber": "0x37946c",
        "address": "0x22c1317fe43132b22860e8b465548613d6151a9f",
        "data": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "topics": [
          "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925",
          "0x000000000000000000000000444589873456c218a274d933a8b5a28821292811",
          "0x000000000000000000000000572af1afa5afcfc6fdf1eb2913aa4463037860e8"
        ]
      },
      {
        "removed": false,
        "logIndex": "0x55",
        "transactionIndex": "0x2a",
        "transactionHash": "0xbffc12fff51d9508c181668cae32364d407fd56ac900213f9529cb4f51865bfc",
        "blockHash": "0x8824b96f41f41ffdf2daf5a0dabc2fd7a76834ec4e81056556e63e467955f520",
        "blockNumber": "0x37946c",
        "address": "0x22c1317fe43132b22860e8b465548613d6151a9f",
        "data": "0x0000000000000000000000000000000000000000000000008ac7230489e80000",
        "topics": [
          "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
          "0x000000000000000000000000444589873456c218a274d933a8b5a28821292811",
          "0x000000000000000000000000572af1afa5afcfc6fdf1eb2913aa4463037860e8"
        ]
      },
      {
        "removed": false,
        "logIndex": "0x56",
        "transactionIndex": "0x2a",
        "transactionHash": "0xbffc12fff51d9508c181668cae32364d407fd56ac900213f9529cb4f51865bfc",
        "blockHash": "0x8824b96f41f41ffdf2daf5a0dabc2fd7a76834ec4e81056556e63e467955f520",
        "blockNumber": "0x37946c",
        "address": "0x572af1afa5afcfc6fdf1eb2913aa4463037860e8",
        "data": "0x6c2dc03a87f42217aa2274127658064f3aae0a7d27f13a1f6054a346baa1e0f500000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000144ef247186000000000000000000000000000000000000000000000000000000000008ea2300000000000000000000000022c1317fe43132b22860e8b465548613d6151a9f00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000444589873456c218a274d933a8b5a288212928110000000000000000000000000000000000000000000000008ac7230489e80000000000000000000000000000000000000000000000000000000000000000001a4d756c74692d73657175656e636572207465737420746f6b656e00000000000000000000000000000000000000000000000000000000000000000000000000044d5345510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "topics": [
          "0xc1d062af3d966b6932252187e7580c22c48379a682867f3fb9c5b7b316a21773"
        ]
      }
    ],
    "logsBloom": "0x00000000000000000000800000000000400000000000000000020000000000000000000000000000000000000000000000000004000000000000000000200000000020000000020000000008000000000000000000000000000000000000000000000000000000001000080000000000000004000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000020000000000004000000000000000000000000000000000000000000000000400000002000000000000004000000000000000000000000000000000000000000010000000000000000000000008000000000000000000800000000000010000",
    "status": "0x1",
    "type": "0x2"
  },
  "txProof": [
    "0xf8b1a0b6a036a2f849eca220b446bfb56804de4ff6ed02c1ea4bfea6d03539e185cd72a087bb5b7829ed3d7a6a40240ba533750f4d7c333c5dd1c7d21d9bb2c9e98925e3a0a5f125fa5e7156cf7046846833a5dc1ab46ec8ee4a24b8502acf7f41ae5e7613a0dd49baaac2643afaf459386fcafc0864b55ae084fe24a6dbc8da24f7096afbca80808080a080c3a6ac818ed92a2afac15ab664024040c5cf3069104cafb3e1135bbb9b5bce8080808080808080",
    "0xf90211a07a0f32ff35d355cdb125ff9b29181998ecbbe0cebc3568cc3caef8fb8bdb7657a05d9a265c7a2b2d01dc689347ce250a2098e983057db4351dfdd412ef46dcfe2ba0874c496b05207f5cdedd58d2185901c2ea6d4514d7a6df88d878947d1a69186ba03cd5ff3aacd9f3bd0afbe3d9cc687970225c0bc8284ee955b4c96ef66a65580aa03d1a0280a289b1b87bcb0aecb5c46c78caafa3cf7c04067bd2734c17b6a894faa05aab9f11f98c6a39c00de9e27541ff96f1b95a03461103f1964aa616fae2c56aa01927759267eb04db9cb1c83c463e7c8b611385e68c3f45d9a57a9730c6a4b9fea0ab1472f55e0f92401687070b3eb41bb543fb7ea0f6e1cdbfb6ba975703dd43c6a0361b63e380a960ca1b4055427b846aac3c1167a452816b8fcee590f78268b15ba0cca661066694396fbd12f4ab432299d88c97c9a41995ea7f5fecee2fc0ceacc1a0def4df98336495935f9f58f457db6f32b7cfc086e42e816a7652afa003106b58a0687bf0fe5ee61b04803401e549c399e7ba2dacc4a58dfc91aa09e005f3861540a044e7cfabd67514a5b19734097ab6642160b0965ef7d82453b6c19fb56f37f8dfa0bddd51f31781f3a773eebfe82d44a0497154566175dbbf4c300c7212a7c1ac17a0aaf0a56a37cac5fb41146b1a3f583df494daa55a9a29200eeb7ed506ae237eb6a0641dd5adb33b417a5ec18496b4c12aeed82f89b76356478f1ca5e6d9b2da1e7680",
    "0xf8d920b8d602f8d383aa36a7038459682f008459682f118302c78894572af1afa5afcfc6fdf1eb2913aa4463037860e880b8641cad5a4000000000000000000000000022c1317fe43132b22860e8b465548613d6151a9f000000000000000000000000444589873456c218a274d933a8b5a288212928110000000000000000000000000000000000000000000000008ac7230489e80000c001a042d4beb18d4a4dd208ff8e9590c48e78273c68dfaf466f68f85df1112afdf420a00c80d8049807c71e3cc3a6f46d7f4ef1fc5470383b976ec123b5d1ccd9853763"
  ],
  "receiptProof": [
    "0xf8b1a05231b85244383c59f3637bcd6eb246815894ffb278a2e8a4c8cd2f1922265126a0909b2aa8a0633b729ee2b624d3845a685af306e2eba434a8841f3df21e6d9a08a030bbfa3639db573f3db51ce7274f882e6206e220490beef1dbbad4efcdb032b1a012a4ca23f7e64361de2438a377a7de56796e4282024e31575f3dc89baaf754e080808080a0e58215be848c1293dd381210359d84485553000a82b67410406d183b42adbbdd8080808080808080",
    "0xf90211a0c9060baee6e299323bfe1b97a032d247f1ef1b852f97fccbcf33d18ef20994d8a0852871bdbddf102a67b38140c3f82a7d9414aac7e64611e14530fa8d572e0457a03e615f9abef2068b7d3810032ec11c8952fa8d0819dbbf09deb9b57c4ff4c288a0a5cfc95b47e5b7a0725fb868efb16c967407c65963aa3e662f497df13c525603a0cca68d823b9f88f92fa88014b24c5e00c36582ebfdfd6c2c4a70a14dadbe7f48a07521108e5b71abdf70d23ba00e346211425b46c23b8b3f5593b95d0ab4e2ad08a056462f0cf673ff3f2522735b3056af7c444198531a7bcfc41ea0bb1b2c70325ea0fdae2c07b4ce7793d503ede0a94059c3e3cfb572fc728d06b4b4d9af720cac32a02d56a12383f51c17f0ed9bb26500ceaa1c3caccc64cdb58e73311e22a162161da0be57112ecf40728fe312676755e868398fb68dc499213d5ecd6e94b4e741be8fa042682cf82733a26dec0fd8f129edf8521a7dad92aafaa6f5d7182fb800cceb7da0fcb4dba2dbf8ca7b3c5d8d9d16d0beaec2d6be2e34d4753a98420bc542ab8e15a02a708857b726a3e56c68692e07fb812c03ed41d0352d43940f43560e80bb3005a0d57bd982c105ef4c642366479ebcdbe47696f7a23b65003da6b8a37f14f50519a0a0d072b6d6022caee3b21614324226a1a924815fc55efbad65c2de506ad55a33a0ca458e3d73e3041dc37de952b267466a765c63592ccde12c1d5b5282c8b9164080",
    "0xf9044a20b9044602f9044201833facc9b9010000000000000000000000800000000000400000000000000000020000000000000000000000000000000000000000000000000004000000000000000000200000000020000000020000000008000000000000000000000000000000000000000000000000000000001000080000000000000004000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000020000000000004000000000000000000000000000000000000000000000000400000002000000000000004000000000000000000000000000000000000000000010000000000000000000000008000000000000000000800000000000010000f90337f89b9422c1317fe43132b22860e8b465548613d6151a9ff863a08c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925a0000000000000000000000000444589873456c218a274d933a8b5a28821292811a0000000000000000000000000572af1afa5afcfc6fdf1eb2913aa4463037860e8a00000000000000000000000000000000000000000000000000000000000000000f89b9422c1317fe43132b22860e8b465548613d6151a9ff863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000444589873456c218a274d933a8b5a28821292811a0000000000000000000000000572af1afa5afcfc6fdf1eb2913aa4463037860e8a00000000000000000000000000000000000000000000000008ac7230489e80000f901fa94572af1afa5afcfc6fdf1eb2913aa4463037860e8e1a0c1d062af3d966b6932252187e7580c22c48379a682867f3fb9c5b7b316a21773b901c06c2dc03a87f42217aa2274127658064f3aae0a7d27f13a1f6054a346baa1e0f500000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000144ef247186000000000000000000000000000000000000000000000000000000000008ea2300000000000000000000000022c1317fe43132b22860e8b465548613d6151a9f00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000444589873456c218a274d933a8b5a288212928110000000000000000000000000000000000000000000000008ac7230489e80000000000000000000000000000000000000000000000000000000000000000001a4d756c74692d73657175656e636572207465737420746f6b656e00000000000000000000000000000000000000000000000000000000000000000000000000044d5345510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
  ],
  "blockHeader": "0xf9022ca020284fa857e2f8efcb77cc946cb572f2df084ecaa588754945e490dea5cd9a91a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d4934794008b3b2f992c0e14edaa6e2c662bec549caa8df1a01069f90354d17b81cc26f08c2731da9d9a9e0bff1e14da64aa17de082d0f768da0b1289c2a0185c150f1cca3c96d138dbdb5a63a9154816a39128f26545fb23db9a00db94af0290a0274fdbc4d2117f2025e74d05d371e39d55b25dc8bdf8720bfa2b9010004800404045100000000801800120000400100800100100084020040100001020002c164048004200000824800080200208003040148c010000c0d0807346000000030011000020000c2000800010a01000000400004080038220102081000000c8800020600000258640804a3000940c20004010903000004400c10048940004c0400010800000210020002408488000100081000104000008c10480082441202000000402600c00804090000031050200284402000800000e000000804500400401012c00800000010046018001080000802018008400144000800000060028010000a005a0400000210400028214080000400008020c20030480430211001808337946c8401c9c380835c0db78464809c608f6769756c696f207761732068657265a0cae9fcdb7165028fe28b088f70df3886c81913d43937a987d7bc51d7cda367d98800000000000000000da0c37b8eaf5d5f4be263703d72f738f25e62641df47267ebcb769031857f8f7ece"
};
